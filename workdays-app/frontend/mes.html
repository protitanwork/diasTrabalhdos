<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mês — Dias Trabalhados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 720px;
      margin: 24px auto;
      padding: 0 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    tfoot td {
      font-weight: bold;
      background: #fafafa;
    }
    a {
      text-decoration: none;
      display: inline-block;
      margin-bottom: 10px;
    }
    .muted {
      opacity: .7;
      font-size: 12px;
    }
  </style>
</head>
<body>

  <a href="index.html">← Voltar</a>

  <h1 id="titulo"></h1>
  <p class="muted">
    O valor do dia é calculado automaticamente usando o € por hora definido na página inicial.
  </p>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Horas</th>
        <th>€ Dia</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <td id="totalDias"></td>
        <td id="totalHoras"></td>
        <td id="totalGanho"></td>
      </tr>
    </tfoot>
  </table>

  <script>
    const API = "http://127.0.0.1:3001/api/workdays";
    const RATE_KEY = "rate_eur_h";

    const params = new URLSearchParams(location.search);
    const mes = params.get("mes"); // ex: "2026-01"

    const tituloEl = document.getElementById("titulo");
    const tbody = document.getElementById("tbody");
    const totalDiasEl = document.getElementById("totalDias");
    const totalHorasEl = document.getElementById("totalHoras");
    const totalGanhoEl = document.getElementById("totalGanho");
    
    const saved = localStorage.getItem(RATE_KEY);
const rate = Number(saved);

if (!Number.isFinite(rate) || rate <= 0) {
  alert("Defina o € por hora na página inicial para calcular o total do mês.");
}


    function nomeMes(yyyyMm) {
      const [y, m] = yyyyMm.split("-").map(Number);
      return new Date(y, m - 1, 1)
        .toLocaleDateString("pt-PT", { month: "long", year: "numeric" });
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function formatarDataBR(iso) {
      return `${iso.slice(8,10)}/${iso.slice(5,7)}/${iso.slice(0,4)}`;
    }

    // Normaliza qualquer formato para { data, horas }
    function normalizar(item) {
      // formato novo
      if (item.data) {
        return {
          data: item.data,
          horas: Number(item.horas) || 0
        };
      }

      // formato antigo (dia + criadoEm)
      if (typeof item.dia === "number") {
        const base = item.criadoEm ? new Date(item.criadoEm) : new Date();
        const y = base.getFullYear();
        const m = pad2(base.getMonth() + 1);
        const d = pad2(item.dia);
        return {
          data: `${y}-${m}-${d}`,
          horas: Number(item.horas) || 0
        };
      }

      return null;
    }

    tituloEl.textContent =
      `Mês: ${nomeMes(mes)} (${mes}) — € ${rate.toFixed(2)}/h`;

    fetch(API)
      .then(res => res.json())
      .then(lista => {
        const normalizados = (lista || [])
          .map(normalizar)
          .filter(Boolean)
          .filter(i => i.data.startsWith(mes))
          .sort((a, b) => a.data.localeCompare(b.data));

        let totalHoras = 0;
        let totalGanho = 0;

        tbody.innerHTML = normalizados.map(item => {
          const ganhoDia = item.horas * rate;
          totalHoras += item.horas;
          totalGanho += ganhoDia;

          return `
            <tr>
              <td>${formatarDataBR(item.data)}</td>
              <td>${item.horas}</td>
              <td>€ ${ganhoDia.toFixed(2)}</td>
            </tr>
          `;
        }).join("") || `
          <tr>
            <td colspan="3">Nenhum dia registrado neste mês.</td>
          </tr>
        `;

        totalDiasEl.textContent = `${normalizados.length} dias`;
        totalHorasEl.textContent = `${totalHoras} horas`;
        totalGanhoEl.textContent = `€ ${totalGanho.toFixed(2)}`;
      })
      .catch(err => {
        tbody.innerHTML = `
          <tr>
            <td colspan="3">Erro ao carregar dados: ${err.message}</td>
          </tr>
        `;
      });
  </script>

</body>
</html>
